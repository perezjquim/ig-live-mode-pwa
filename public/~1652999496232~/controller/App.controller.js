sap.ui.define(["./util/BaseController","sap/ui/core/routing/History","sap/ui/core/Fragment","sap/ui/util/Storage","sap/ui/Device","./util/SWHelper","./util/AdditionalAuthHelper"],function(t,e,o,s,i,n,a){"use strict";return t.extend("com.perezjquim.iglivemode.pwa.controller.App",{onInit:function(t){const e=new n(this);e.init();this._oAddtionalAuthHelper=new a(this);this._checkLogin()},onHomeButtonPress:function(t){const e=t.getSource();const o=e.getParent();const s=o.getSideContent();const i=s.getItem();const n=i.getItems();const a=n.find(function(t){const e=t.getKey();return e=="Home"});i.fireItemSelect({item:a})},onMenuButtonPress:function(t){const e=t.getSource();const o=e.getParent();const s=o.getSideExpanded();o.setSideExpanded(!s)},onNavigationItemSelect:function(t){const e=t.getParameter("item");const o=e.getKey();this.navTo(o);const s=i.system.phone;if(s){const e=t.getSource();const o=e.getParent();o.setSideExpanded(false)}},onNavButtonPress:function(t){this.navBack()},_checkLogin:function(){const t=Boolean(localStorage.getItem("ig_settings"));if(t){(async function(){this.fetchData()}).bind(this)()}else{this._askForLogin()}},fetchData:function(){this._fetchUserInfo();this._fetchConfig()},_fetchUserInfo:async function(){this.setBusy(true);try{const t=await fetch(`${this.API_BASE_URL}/get-user-info`,{method:"GET",headers:this._getHeaders()});if(t.ok){const e=await t.json();const o=this.getModel("ig_user_info");o.setData(e)}else{const e=await t.text();console.warn(e);this.toast(e)}}catch(t){console.warn(t);this.toast(t)}this.setBusy(false)},_fetchConfig:async function(){try{const t=await fetch(`${this.API_BASE_URL}/get-config`,{method:"GET",headers:this._getHeaders()});if(t.ok){const e=await t.json();const o=this.getModel("config");o.setData(e);const s=this._copy(e);const i=this.getModel("config_draft");i.setData(s);this._listenConfigChanges()}else{const e=await t.text();console.warn(e);this.toast(e)}}catch(t){console.warn(t);this.toast(t)}const t=this.getModel("misc");t.setProperty("/is_config_loaded",true)},_askForLogin:function(){if(!this._oLoginPromptDialog){this.setBusy(true);o.load({name:"com.perezjquim.iglivemode.pwa.view.fragment.LoginPrompt",controller:this}).then(function(t){this.setBusy(false);const e=this.getView();e.addDependent(t);t.open();this._oLoginPromptDialog=t}.bind(this))}else{this._oLoginPromptDialog.open()}},onBeforeOpenLoginPrompt:function(t){this.clearModel("login_prompt")},onAfterCloseLoginPrompt:function(t){this.clearModel("login_prompt")},onConfirmLogin:async function(t){this.setBusy(true);const e=this.getModel("login_prompt");const s=e.getData();const i=s["user"];const n=s["pw"];if(i&&n){const t="Basic "+btoa(i+":"+n);try{const e=await fetch(`${this.API_BASE_URL}/login`,{method:"POST",headers:{Authorization:t}});if(e.ok){const t=await e.json();const o=JSON.stringify(t);localStorage.setItem("ig_settings",o);this.fetchData();const s=this.getText("action_success");this.toast(s);this._oLoginPromptDialog.close()}else if(e.status==428){const s=await e.json();const i=this.getModel("additional_auth_prompt");i.setData(s);i.setProperty("/authorization",t);this._oLoginPromptDialog.close();if(!this._oAdditionalAuthPromptDialog){this.setBusy(true);o.load({name:"com.perezjquim.iglivemode.pwa.view.fragment.AdditionalAuthPrompt",controller:this}).then(function(t){this.setBusy(false);const e=this.getView();e.addDependent(t);t.open();this._oAdditionalAuthPromptDialog=t}.bind(this))}else{this._oAdditionalAuthPromptDialog.open()}}else{const t=await e.text();console.warn(t);this.toast(t)}}catch(t){console.warn(t);this.toast(t)}this.setBusy(false)}else{this.setBusy(false);const t=this.getText("incomplete_data");this.toast(t)}},dummyEscapeHandler:function(t){t.reject()},onAvatarPress:function(t){const e=t.getSource();if(!this._oUserDetailsPopover){this.setBusy(true);o.load({name:"com.perezjquim.iglivemode.pwa.view.fragment.UserDetailsPopover",controller:this}).then(function(t){this.setBusy(false);const o=this.getView();o.addDependent(t);t.openBy(e);this._oUserDetailsPopover=t}.bind(this))}else{if(this._oUserDetailsPopover.isOpen()){this._oUserDetailsPopover.close()}else{this._oUserDetailsPopover.openBy(e)}}},onLogoff:function(t){this.setBusy(true);localStorage.removeItem("ig_settings");location.reload()},onAfterCloseAdditionalAuthPrompt:function(t){this._oAddtionalAuthHelper.onAfterCloseAdditionalAuthPrompt(t)},onConfirmAdditionalAuth:async function(t){this._oAddtionalAuthHelper.onConfirmAdditionalAuth(t)}})});